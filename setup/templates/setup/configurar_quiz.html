{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Configurar Quiz</title>
    <link rel="stylesheet" href="{% static 'setup/configurar_quiz.css' %}">
</head>
<body>
    <div class="container">
        
        <img src="{% static 'unnamed.png' %}" alt="Logo Code Quiz" class="logo-image">
        
        <h2>CONFIGURAR QUIZ</h2>

        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li style="color:red;">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <form id="quiz-config-form">
            
            <div class="form-group">
                <label for="linguagem-select">Selecione a Linguagem:</label>
                <select name="linguagem" id="linguagem-select">
                    <option value="">-- Escolha a Linguagem --</option>
                    {% for linguagem in linguagens %}
                        <option value="{{ linguagem.id }}">{{ linguagem.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="assunto-select">Selecione o Assunto:</label>
                <select name="assunto" id="assunto-select" disabled>
                    <option value="">-- Escolha um assunto --</option>
                </select>
            </div>
            
            <button type="submit" id="gerar-quiz-btn" disabled>INICIAR QUIZ</button>
        </form>

    <script>
        const linguagemSelect = document.getElementById('linguagem-select');
        const assuntoSelect = document.getElementById('assunto-select');
        const quizForm = document.getElementById('quiz-config-form');
        const gerarQuizBtn = document.getElementById('gerar-quiz-btn');

        linguagemSelect.addEventListener('change', function() {
            const linguagemId = this.value;
            assuntoSelect.innerHTML = '<option value="">-- Carregando... --</option>';
            gerarQuizBtn.disabled = true;

            if (!linguagemId) {
                assuntoSelect.innerHTML = '<option value="">-- Primeiro, escolha uma linguagem --</option>';
                assuntoSelect.disabled = true;
                return;
            }

            fetch(`/api/assuntos/${linguagemId}/`)
                .then(response => {
                    if (!response.ok) { throw new Error('Erro na rede ao buscar assuntos'); }
                    return response.json();
                })
                .then(data => {
                    assuntoSelect.innerHTML = '<option value="">-- Escolha o Assunto --</option>';
                    data.forEach(assunto => {
                        const option = document.createElement('option');
                        option.value = assunto.url; 
                        option.textContent = assunto.nome;
                        assuntoSelect.appendChild(option);
                    });
                    assuntoSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erro no fetch:', error);
                    assuntoSelect.innerHTML = '<option value="">-- Erro ao carregar --</option>';
                });
        });

        assuntoSelect.addEventListener('change', function() {
            gerarQuizBtn.disabled = !this.value;
        });

        quizForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            const redirectUrl = assuntoSelect.value;

            if (redirectUrl) {
                window.location.href = redirectUrl;
            } else {
                alert('Por favor, selecione um assunto.');
            }
        });
    </script>
    </div>
</body>
</html>